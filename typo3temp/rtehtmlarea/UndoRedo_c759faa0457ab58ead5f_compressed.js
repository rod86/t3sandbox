HTMLArea.UndoRedo=HTMLArea.Plugin.extend({constructor:function(editor,pluginName){this.base(editor,pluginName);},configurePlugin:function(editor){this.pageTSconfiguration=this.editorConfiguration.buttons.undo;this.customUndo=true;this.undoQueue=new Array();this.undoPosition=-1;this.undoSteps=25;this.undoTimeout=500;var pluginInformation={version:'2.0',developer:'Stanislas Rolland',developerUrl:'http://www.sjbr.ca',copyrightOwner:'Stanislas Rolland',sponsor:'SJBR',sponsorUrl:'http://www.sjbr.ca',license:'GPL'};this.registerPluginInformation(pluginInformation);var buttonList=this.buttonList,buttonId;for(var i=0;i<buttonList.length;++i){var button=buttonList[i];buttonId=button[0];var buttonConfiguration={id:buttonId,tooltip:this.localize(buttonId.toLowerCase()),iconCls:'htmlarea-action-'+button[3],action:'onButtonPress',hotKey:((this.editorConfiguration.buttons[buttonId.toLowerCase()]&&this.editorConfiguration.buttons[buttonId.toLowerCase()].hotKey)?this.editorConfiguration.buttons[buttonId.toLowerCase()].hotKey:button[2]),noAutoUpdate:true};this.registerButton(buttonConfiguration);}
return true;},buttonList:[['Undo',null,'z','undo'],['Redo',null,'y','redo']],onGenerate:function(){if(this.customUndo){this.task={run:this.takeSnapshot,scope:this,interval:this.undoTimeout};this.start();}},start:function(){if(this.customUndo){Ext.TaskMgr.start(this.task);}},stop:function(){if(this.customUndo){Ext.TaskMgr.stop(this.task);}},takeSnapshot:function(){var currentTime=(new Date()).getTime();var newSnapshot=false;if(this.undoPosition>=this.undoSteps){this.undoQueue.shift();--this.undoPosition;}
if(this.undoPosition<0||this.undoQueue[this.undoPosition].time<currentTime-this.undoTimeout){++this.undoPosition;newSnapshot=true;}
var text=this.editor.getInnerHTML();if(newSnapshot){if(this.undoPosition==0||this.undoQueue[this.undoPosition-1].text!=text){this.undoQueue[this.undoPosition]=this.buildSnapshot();this.undoQueue[this.undoPosition].time=currentTime;this.undoQueue.length=this.undoPosition+1;this.updateButtonsState();}else{--this.undoPosition;}}else{if(this.undoQueue[this.undoPosition].text!=text){var snapshot=this.buildSnapshot();this.undoQueue[this.undoPosition].text=snapshot.text;this.undoQueue[this.undoPosition].bookmark=snapshot.bookmark;this.undoQueue[this.undoPosition].bookmarkedText=snapshot.bookmarkedText;this.undoQueue.length=this.undoPosition+1;}}},buildSnapshot:function(){var bookmark=null,bookmarkedText=null;if(this.editor.getMode()=='wysiwyg'&&this.editor.isEditable()){var selection=this.editor._getSelection();if((!Ext.isIE&&!(Ext.isOpera&&navigator.userAgent.toLowerCase().indexOf('presto/2.1')!=-1))||(Ext.isIE&&selection.type.toLowerCase()!='control')){try{bookmark=this.editor.getBookmark(this.editor._createRange(selection));}catch(e){bookmark=null;}}
if(bookmark){bookmarkedText=this.editor.getInnerHTML();var range=this.editor.moveToBookmark(bookmark);if(Ext.isGecko){this.editor.emptySelection(selection);this.editor.addRangeToSelection(selection,range);}}}
return{text:this.editor.getInnerHTML(),bookmark:bookmark,bookmarkedText:bookmarkedText};},undo:function(){if(this.undoPosition>0){this.takeSnapshot();this.setContent(--this.undoPosition);this.updateButtonsState();}},redo:function(){if(this.undoPosition<this.undoQueue.length-1){this.takeSnapshot();if(this.undoPosition<this.undoQueue.length-1){this.setContent(++this.undoPosition);this.updateButtonsState();}}},setContent:function(undoPosition){var bookmark=this.undoQueue[undoPosition].bookmark;if(bookmark){this.editor.setHTML(this.undoQueue[undoPosition].bookmarkedText);this.editor.focus();this.editor.selectRange(this.editor.moveToBookmark(bookmark));this.editor.scrollToCaret();}else{this.editor.setHTML(this.undoQueue[undoPosition].text);}},onUpdateToolbar:function(button,mode,selectionEmpty,ancestors){if(mode=='wysiwyg'&&this.editor.isEditable()){if(this.customUndo){switch(button.itemId){case'Undo':button.setDisabled(this.undoPosition==0);break;case'Redo':button.setDisabled(this.undoPosition>=this.undoQueue.length-1);break;}}else{try{button.setDisabled(!this.editor._doc.queryCommandEnabled(button.itemId));}catch(e){button.setDisabled(true);}}}else{button.setDisabled(!button.textMode);}},updateButtonsState:function(){var mode=this.getEditorMode(),selectionEmpty=true,ancestors=null;if(mode==='wysiwyg'){selectionEmpty=this.editor._selectionEmpty(this.editor._getSelection());ancestors=this.editor.getAllAncestors();}
var button=this.getButton('Undo');if(button){this.onUpdateToolbar(button,mode,selectionEmpty,ancestors)}
var button=this.getButton('Redo');if(button){this.onUpdateToolbar(button,mode,selectionEmpty,ancestors)}},onButtonPress:function(editor,id){var buttonId=this.translateHotKey(id);buttonId=buttonId?buttonId:id;if(this.getButton(buttonId)&&!this.getButton(buttonId).disabled){if(this.customUndo){this[buttonId.toLowerCase()]();}else{this.editor._doc.execCommand(buttonId,false,null);}}
return false;}});